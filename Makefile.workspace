#!/usr/bin/make -f

# Go Workspace Makefile for SIX Protocol
# This Makefile helps manage the Go workspace with multiple modules

.PHONY: help workspace-init workspace-sync workspace-test workspace-build workspace-clean
.PHONY: sixclient-test sixclient-build sixclient-example main-test main-build
.PHONY: deps-update deps-verify workspace-status

# Default target
help:
	@echo "Go Workspace Management for SIX Protocol"
	@echo ""
	@echo "Available commands:"
	@echo "  workspace-init    - Initialize Go workspace"
	@echo "  workspace-sync    - Sync all module dependencies"
	@echo "  workspace-test    - Run tests for all modules"
	@echo "  workspace-build   - Build all modules"
	@echo "  workspace-clean   - Clean all build artifacts"
	@echo "  workspace-status  - Show workspace status"
	@echo ""
	@echo "SixClient commands:"
	@echo "  sixclient-test    - Test sixclient module"
	@echo "  sixclient-build   - Build sixclient module"
	@echo "  sixclient-example - Run sixclient examples"
	@echo ""
	@echo "Main module commands:"
	@echo "  main-test         - Test main six-protocol module"
	@echo "  main-build        - Build main six-protocol module"
	@echo ""
	@echo "Dependency commands:"
	@echo "  deps-update       - Update all dependencies"
	@echo "  deps-verify       - Verify all dependencies"
	@echo ""
	@echo "Test commands:"
	@echo "  test-workspace    - Test workspace setup"
	@echo ""
	@echo "Environment variables:"
	@echo "  MNEMONIC          - Wallet mnemonic for testing"

# Initialize Go workspace
workspace-init:
	@echo "ğŸ”§ Initializing Go workspace..."
	@if [ ! -f go.work ]; then \
		echo "Creating go.work file..."; \
		go work init . ./sixclient; \
	else \
		echo "go.work already exists"; \
	fi
	@echo "âœ… Workspace initialized"

# Sync all module dependencies
workspace-sync:
	@echo "ğŸ”„ Syncing workspace dependencies..."
	go work sync
	@echo "âœ… Dependencies synchronized"

# Test all modules in workspace
workspace-test:
	@echo "ğŸ§ª Running tests for all modules..."
	go test ./...
	go test ./sixclient/...
	@echo "âœ… All tests completed"

# Build all modules
workspace-build: main-build sixclient-build
	@echo "âœ… All modules built successfully"

# Clean all build artifacts
workspace-clean:
	@echo "ğŸ§¹ Cleaning workspace..."
	go clean ./...
	go clean ./sixclient/...
	rm -f test_workspace
	rm -f sixclient/examples/basic_usage
	@echo "âœ… Workspace cleaned"

# Show workspace status
workspace-status:
	@echo "ğŸ“Š Go Workspace Status"
	@echo "======================"
	@echo "Go version: $(shell go version)"
	@echo ""
	@echo "Workspace modules:"
	@go list -m -f '{{.Path}} {{.Dir}}' all | head -10
	@echo ""
	@echo "Active go.work file:"
	@if [ -f go.work ]; then \
		cat go.work; \
	else \
		echo "No go.work file found"; \
	fi

# Test sixclient module specifically
sixclient-test:
	@echo "ğŸ§ª Testing sixclient module..."
	cd sixclient && go test -v ./...
	@echo "âœ… SixClient tests completed"

# Build sixclient module
sixclient-build:
	@echo "ğŸ”¨ Building sixclient module..."
	cd sixclient && go build ./...
	@echo "âœ… SixClient built successfully"

# Run sixclient examples
sixclient-example:
	@echo "ğŸš€ Running sixclient examples..."
	@if [ -z "$(MNEMONIC)" ]; then \
		echo "âš ï¸  MNEMONIC environment variable not set"; \
		echo "   Using test mnemonic for demonstration"; \
		cd sixclient/examples && go run basic_usage.go; \
	else \
		echo "âœ… Using provided MNEMONIC"; \
		cd sixclient/examples && MNEMONIC="$(MNEMONIC)" go run basic_usage.go; \
	fi

# Test main six-protocol module
main-test:
	@echo "ğŸ§ª Testing main six-protocol module..."
	go test ./x/... ./app/...
	@echo "âœ… Main module tests completed"

# Build main six-protocol module
main-build:
	@echo "ğŸ”¨ Building main six-protocol module..."
	go build ./cmd/sixd
	@echo "âœ… Main module built successfully"

# Update all dependencies
deps-update:
	@echo "â¬†ï¸  Updating dependencies..."
	go get -u ./...
	cd sixclient && go get -u ./...
	go mod tidy
	cd sixclient && go mod tidy
	go work sync
	@echo "âœ… All dependencies updated"

# Verify all dependencies
deps-verify:
	@echo "ğŸ” Verifying dependencies..."
	go mod verify
	cd sixclient && go mod verify
	@echo "âœ… All dependencies verified"

# Test workspace setup
test-workspace:
	@echo "ğŸ§ª Testing workspace setup..."
	@if [ ! -f test_workspace.go ]; then \
		echo "âŒ test_workspace.go not found"; \
		exit 1; \
	fi
	go run test_workspace.go
	@echo "âœ… Workspace test completed"

# Format all Go code
format:
	@echo "ğŸ¨ Formatting Go code..."
	go fmt ./...
	cd sixclient && go fmt ./...
	@echo "âœ… Code formatted"

# Run linters
lint:
	@echo "ğŸ” Running linters..."
	@if command -v golangci-lint >/dev/null 2>&1; then \
		golangci-lint run ./...; \
		cd sixclient && golangci-lint run ./...; \
	else \
		echo "golangci-lint not installed, running go vet instead"; \
		go vet ./...; \
		cd sixclient && go vet ./...; \
	fi
	@echo "âœ… Linting completed"

# Install development tools
install-tools:
	@echo "ğŸ› ï¸  Installing development tools..."
	go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	@echo "âœ… Development tools installed"

# Generate documentation
docs:
	@echo "ğŸ“š Generating documentation..."
	go doc -all ./sixclient > docs/sixclient-api.md
	@echo "âœ… Documentation generated"

# Create release build
release: workspace-clean workspace-test workspace-build
	@echo "ğŸš€ Creating release build..."
	@echo "âœ… Release build completed"

# Development setup
dev-setup: workspace-init workspace-sync install-tools
	@echo "ğŸ”§ Setting up development environment..."
	@echo ""
	@echo "âœ… Development environment ready!"
	@echo ""
	@echo "Next steps:"
	@echo "  1. Set your MNEMONIC environment variable"
	@echo "  2. Run: make test-workspace"
	@echo "  3. Run: make sixclient-example"
	@echo ""
	@echo "Example:"
	@echo "  export MNEMONIC='your twelve word mnemonic here'"
	@echo "  make test-workspace"

# Quick test with sample data
quick-test:
	@echo "âš¡ Running quick tests..."
	@echo "Testing workspace setup..."
	@$(MAKE) test-workspace
	@echo ""
	@echo "Testing sixclient build..."
	@$(MAKE) sixclient-build
	@echo ""
	@echo "âœ… Quick test completed"

# Show workspace info
info:
	@echo "â„¹ï¸  SIX Protocol Go Workspace Information"
	@echo "========================================"
	@echo ""
	@echo "Project structure:"
	@echo "  ğŸ“ six-protocol/           - Main blockchain module"
	@echo "  ğŸ“ sixclient/             - Go SDK for SIX Protocol"
	@echo "  ğŸ“ sixclient/examples/    - Usage examples"
	@echo "  ğŸ“„ go.work                - Workspace configuration"
	@echo "  ğŸ“„ Makefile.workspace     - This makefile"
	@echo ""
	@echo "Key files:"
	@echo "  ğŸ”§ go.mod                 - Main module dependencies"
	@echo "  ğŸ”§ sixclient/go.mod       - SixClient dependencies"
	@echo "  ğŸ“ test_workspace.go      - Workspace test script"
	@echo ""
	@echo "Usage:"
	@echo "  make help                 - Show all commands"
	@echo "  make dev-setup            - Setup development environment"
	@echo "  make workspace-test       - Test all modules"
	@echo "  make sixclient-example    - Run SDK examples"
	@echo ""
	@echo "ğŸ”— Documentation: sixclient/README.md"
